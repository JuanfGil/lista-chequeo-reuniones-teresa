<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Ficha de Reuniones para Delegados</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      font-family: Calibri, Arial, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: #ffffff;
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Encabezado */
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .header-logo {
      width: 150px;
      height: 150px;
      border-radius: 10px;
      background: #f8bbd0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      text-align: center;
      padding: 4px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(233, 30, 99, 0.25);
    }

    .header-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .header-title {
      flex: 1;
      padding: 10px 16px;
      border-radius: 8px;
      background: linear-gradient(to right, #e91e63, #ff80ab);
      color: #fff;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 16px;
      text-align: center;
      line-height: 1.3;
    }

    @media (max-width: 700px) {
      .header {
        flex-direction: column;
        align-items: center;
      }

      .header-logo {
        width: 200px;
        height: 200px;
        margin-bottom: 8px;
      }

      .header-title {
        width: 100%;
        font-size: 15px;
      }
    }

    /* Layout */
    .content {
      display: grid;
      grid-template-columns: 1fr 1.1fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .content {
        grid-template-columns: 1fr;
      }
    }

    /* Tarjetas */
    .card {
      border-radius: 8px;
      border: 1px solid #f8bbd0;
      padding: 14px;
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(233, 30, 99, 0.08);
    }

    .card-title {
      margin-top: 0;
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 13px;
      text-transform: uppercase;
      padding: 8px 10px;
      border-radius: 6px;
      background-color: #fce4ec;
      color: #880e4f;
    }

    /* Formulario: vertical */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      font-size: 13px;
    }

    .form-group label {
      margin-bottom: 3px;
      font-weight: 600;
    }

    .form-group input,
    .form-group textarea {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 60px;
    }

    /* Botones */
    .btn-row {
      margin-top: 16px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
      min-width: 130px;
    }

    .btn-primary {
      background-color: #e91e63;
      color: #fff;
    }

    .btn-secondary {
      background-color: #f06292;
      color: #fff;
    }

    .btn-danger {
      background-color: #d32f2f;
      color: #fff;
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 12px;
      min-width: auto;
      border-radius: 16px;
    }

    @media (max-width: 700px) {
      .btn-row {
        flex-direction: column;
        align-items: center;
      }

      .btn {
        width: auto;
        padding: 10px 16px;
        min-width: 150px;
      }
    }

    /* Tabla */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background-color: #ad1457;
      color: #fff;
    }

    th, td {
      border: 1px solid #f8bbd0;
      padding: 6px;
      text-align: left;
      vertical-align: top;
    }

    tbody tr:nth-child(even) {
      background-color: #fce4ec;
    }

    .actions-cell {
      white-space: nowrap;
      text-align: center;
    }

    /* Filtro y admin */
    .top-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      font-size: 12px;
      flex: 1;
      min-width: 180px;
    }

    .filter-group input {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 12px;
    }

    .admin-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 11px;
      justify-content: flex-end;
    }

    #estadoVista {
      font-style: italic;
      color: #880e4f;
    }

    /* Modal admin */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: #fff;
      border-radius: 10px;
      padding: 18px 16px;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }

    .modal-title {
      margin: 0 0 10px;
      font-size: 14px;
      font-weight: bold;
      color: #880e4f;
    }

    .modal input[type="password"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
      margin-bottom: 12px;
    }

    .modal-btns {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
  </style>
</head>
<body>
  <div class="app-container">

    <header class="header">
      <div class="header-logo">
        <img src="teresaaa.jpg" alt="Dra. Teresa"
             onerror="this.style.display='none'; this.parentElement.innerHTML='Foto<br>Dra. Teresa';">
      </div>

      <div class="header-title">
        FICHA DE REUNIONES PARA DELEGADOS
      </div>
    </header>

    <div class="content">

      <!-- FORMULARIO -->
      <section class="card">
        <h2 class="card-title">Datos de la reuni贸n</h2>

        <div class="form-grid">
          <div class="form-group">
            <label for="delegados">Delegados</label>
            <input type="text" id="delegados" />
          </div>

          <div class="form-group">
            <label for="fecha">Fecha</label>
            <input type="date" id="fecha" />
          </div>

          <div class="form-group">
            <label for="hora">Hora</label>
            <input type="time" id="hora" />
          </div>

          <div class="form-group">
            <label for="lugar">Lugar</label>
            <input type="text" id="lugar" />
          </div>

          <div class="form-group">
            <label for="municipio">Municipio</label>
            <input type="text" id="municipio" />
          </div>

          <div class="form-group">
            <label for="lider">L铆der u organizaci贸n que convoca</label>
            <input type="text" id="lider" />
          </div>

          <div class="form-group">
            <label for="celular">Celular</label>
            <input type="tel" id="celular" />
          </div>

          <div class="form-group">
            <label for="asistentes">N煤mero de asistentes</label>
            <input type="number" id="asistentes" min="0" />
          </div>

          <div class="form-group">
            <label for="tipoPoblacion">Tipo de poblaci贸n</label>
            <input type="text" id="tipoPoblacion" />
          </div>

          <div class="form-group">
            <label for="observaciones">Observaciones</label>
            <textarea id="observaciones"></textarea>
          </div>

          <div class="form-group">
            <label for="notas">Notas pendientes por parte de la Dra. Teresa / Delegado</label>
            <textarea id="notas"></textarea>
          </div>
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" id="btnGuardar">Guardar reuni贸n</button>
          <button class="btn btn-secondary" id="btnLimpiar">Limpiar formulario</button>
        </div>
      </section>

      <!-- TABLA -->
      <section class="card">
        <h2 class="card-title" style="background:#e91e63; color:white;">
          Reuniones registradas
        </h2>

        <div class="top-controls">
          <div class="filter-group">
            <label for="filtroDelegado">Filtrar por delegado</label>
            <input type="text" id="filtroDelegado" placeholder="Escribe el nombre del delegado" />
          </div>

          <div class="admin-controls">
            <button class="btn btn-secondary btn-sm" id="btnAdmin">Activar modo administrador</button>
            <button class="btn btn-primary btn-sm" id="btnExcel" disabled>Descargar Excel</button>
            <span id="estadoVista"></span>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Delegados</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Lugar</th>
              <th>Municipio</th>
              <th>L铆der u organizaci贸n</th>
              <th>Celular</th>
              <th>N掳 asistentes</th>
              <th>Tipo poblaci贸n</th>
              <th>Observaciones</th>
              <th>Notas</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaReuniones"></tbody>
        </table>
      </section>
    </div>
  </div>

  <!-- MODAL DE ADMIN -->
  <div class="modal-backdrop" id="modalAdmin">
    <div class="modal">
      <h3 class="modal-title">Modo administrador</h3>
      <p>Ingresa la contrase帽a para ver todas las reuniones y habilitar edici贸n/eliminaci贸n.</p>
      <input type="password" id="inputAdminPwd" placeholder="Contrase帽a" />

      <div class="modal-btns">
        <button class="btn btn-secondary btn-sm" id="btnCancelarAdmin">Cancelar</button>
        <button class="btn btn-primary btn-sm" id="btnConfirmarAdmin">Aceptar</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    const DEVICE_KEY = 'idDispositivoTeresa';
    const ADMIN_PASSWORD = 'teresa2025';

    //  CAMBIA ESTO POR TU URL REAL DEL API EN RENDER
    const API_BASE_URL = 'https://lista-chequeo-reuniones-teresa.onrender.com';

    let reuniones = [];
    let indiceEdicion = null;
    let modoAdmin = false;
    let idDispositivo = null;

    const $ = (id) => document.getElementById(id);

    const inputDelegados = $('delegados');
    const inputFecha = $('fecha');
    const inputHora = $('hora');
    const inputLugar = $('lugar');
    const inputMunicipio = $('municipio');
    const inputLider = $('lider');
    const inputCelular = $('celular');
    const inputAsistentes = $('asistentes');
    const inputTipoPoblacion = $('tipoPoblacion');
    const inputObservaciones = $('observaciones');
    const inputNotas = $('notas');

    const btnGuardar = $('btnGuardar');
    const btnLimpiar = $('btnLimpiar');
    const tbody = $('tablaReuniones');

    const filtroDelegado = $('filtroDelegado');
    const btnAdmin = $('btnAdmin');
    const btnExcel = $('btnExcel');
    const estadoVista = $('estadoVista');

    const modalAdmin = $('modalAdmin');
    const inputAdminPwd = $('inputAdminPwd');
    const btnCancelarAdmin = $('btnCancelarAdmin');
    const btnConfirmarAdmin = $('btnConfirmarAdmin');

    function generarIdDispositivo() {
      return 'disp-' + Date.now() + '-' + Math.floor(Math.random() * 100000);
    }

    function obtenerIdDispositivo() {
      let id = localStorage.getItem(DEVICE_KEY);
      if (!id) {
        id = generarIdDispositivo();
        localStorage.setItem(DEVICE_KEY, id);
      }
      return id;
    }

    function obtenerDatosFormulario() {
      return {
        delegados: inputDelegados.value.trim(),
        fecha: inputFecha.value,
        hora: inputHora.value,
        lugar: inputLugar.value.trim(),
        municipio: inputMunicipio.value.trim(),
        lider: inputLider.value.trim(),
        celular: inputCelular.value.trim(),
        asistentes: inputAsistentes.value ? parseInt(inputAsistentes.value, 10) : null,
        tipoPoblacion: inputTipoPoblacion.value.trim(),
        observaciones: inputObservaciones.value.trim(),
        notas: inputNotas.value.trim(),
        dispositivoId: idDispositivo
      };
    }

    function validarDatos(datos) {
      if (!datos.delegados) return 'El campo "Delegados" es obligatorio.';
      if (!datos.fecha) return 'El campo "Fecha" es obligatorio.';
      if (!datos.hora) return 'El campo "Hora" es obligatorio.';
      if (!datos.lugar) return 'El campo "Lugar" es obligatorio.';
      if (!datos.municipio) return 'El campo "Municipio" es obligatorio.';
      if (!datos.lider) return 'El campo "L铆der" es obligatorio.';
      return null;
    }

    function limpiarFormulario() {
      inputDelegados.value = '';
      inputFecha.value = '';
      inputHora.value = '';
      inputLugar.value = '';
      inputMunicipio.value = '';
      inputLider.value = '';
      inputCelular.value = '';
      inputAsistentes.value = '';
      inputTipoPoblacion.value = '';
      inputObservaciones.value = '';
      inputNotas.value = '';
      indiceEdicion = null;
      btnGuardar.textContent = 'Guardar reuni贸n';
    }

    function actualizarEstadoVista() {
      estadoVista.textContent = modoAdmin
        ? 'Mostrando todas las reuniones.'
        : 'Mostrando reuniones de este dispositivo.';
    }

    function obtenerRegistrosFiltrados() {
      const filtro = filtroDelegado.value.toLowerCase().trim();
      return reuniones.filter(r =>
        (r.delegados || '').toLowerCase().includes(filtro)
      );
    }

    function pintarTabla() {
      tbody.innerHTML = '';
      const registros = obtenerRegistrosFiltrados();

      registros.forEach((r, index) => {
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${r.delegados}</td>
          <td>${r.fecha || ''}</td>
          <td>${r.hora || ''}</td>
          <td>${r.lugar || ''}</td>
          <td>${r.municipio || ''}</td>
          <td>${r.lider || ''}</td>
          <td>${r.celular || ''}</td>
          <td>${r.asistentes ?? ''}</td>
          <td>${r.tipo_poblacion || r.tipoPoblacion || ''}</td>
          <td>${r.observaciones || ''}</td>
          <td>${r.notas || ''}</td>
          <td class="actions-cell">
            ${
              modoAdmin
                ? `
                  <button class="btn btn-secondary btn-sm" data-accion="editar" data-index="${index}">Editar</button>
                  <button class="btn btn-danger btn-sm" data-accion="eliminar" data-index="${index}">Eliminar</button>
                `
                : `<span style="font-size:11px; color:#777;">Solo admin</span>`
            }
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function cargarReunionesDesdeApi() {
      try {
        let url = `${API_BASE_URL}/api/reuniones`;
        url += modoAdmin
          ? `?modo=admin&password=${ADMIN_PASSWORD}`
          : `?dispositivoId=${idDispositivo}`;

        const res = await fetch(url);
        reuniones = await res.json();
        pintarTabla();
      } catch (err) {
        alert('No se pudo cargar la informaci贸n.');
      }
    }

    async function crearReunion(datos) {
      await fetch(`${API_BASE_URL}/api/reuniones`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
      });
    }

    async function actualizarReunion(id, datos) {
      await fetch(`${API_BASE_URL}/api/reuniones/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
      });
    }

    async function eliminarReunion(id) {
      await fetch(`${API_BASE_URL}/api/reuniones/${id}`, {
        method: 'DELETE'
      });
    }

    // ADMIN
    function abrirModal() {
      modalAdmin.style.display = 'flex';
      inputAdminPwd.value = '';
      setTimeout(() => inputAdminPwd.focus(), 100);
    }

    function cerrarModal() {
      modalAdmin.style.display = 'none';
    }

    async function intentarEntrarAdmin() {
      if (inputAdminPwd.value !== ADMIN_PASSWORD) {
        alert('Contrase帽a incorrecta.');
        return;
      }
      modoAdmin = true;
      cerrarModal();
      btnAdmin.textContent = 'Salir de modo administrador';
      btnExcel.disabled = false;
      await cargarReunionesDesdeApi();
      actualizarEstadoVista();
    }

    // EVENTOS
    btnGuardar.addEventListener('click', async () => {
      const datos = obtenerDatosFormulario();
      const error = validarDatos(datos);
      if (error) return alert(error);

      if (indiceEdicion === null) {
        await crearReunion(datos);
      } else {
        const registro = reuniones[indiceEdicion];
        await actualizarReunion(registro.id, datos);
      }

      await cargarReunionesDesdeApi();
      limpiarFormulario();
    });

    btnLimpiar.addEventListener('click', limpiarFormulario);

    filtroDelegado.addEventListener('input', pintarTabla);

    btnAdmin.addEventListener('click', () => {
      if (modoAdmin) {
        modoAdmin = false;
        btnAdmin.textContent = 'Activar modo administrador';
        btnExcel.disabled = true;
        cargarReunionesDesdeApi();
        actualizarEstadoVista();
      } else abrirModal();
    });

    btnCancelarAdmin.addEventListener('click', cerrarModal);
    btnConfirmarAdmin.addEventListener('click', intentarEntrarAdmin);

    modalAdmin.addEventListener('click', (e) => {
      if (e.target === modalAdmin) cerrarModal();
    });

    tbody.addEventListener('click', async (e) => {
      const btn = e.target;
      const accion = btn.dataset.accion;
      const index = btn.dataset.index;

      if (!accion) return;
      if (!modoAdmin) return alert('Solo el administrador puede editar o eliminar.');

      const r = reuniones[index];

      if (accion === 'editar') {
        inputDelegados.value = r.delegados;
        inputFecha.value = r.fecha || '';
        inputHora.value = r.hora || '';
        inputLugar.value = r.lugar || '';
        inputMunicipio.value = r.municipio || '';
        inputLider.value = r.lider || '';
        inputCelular.value = r.celular || '';
        inputAsistentes.value = r.asistentes ?? '';
        inputTipoPoblacion.value = r.tipo_poblacion || '';
        inputObservaciones.value = r.observaciones || '';
        inputNotas.value = r.notas || '';
        indiceEdicion = index;
        btnGuardar.textContent = 'Actualizar reuni贸n';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      if (accion === 'eliminar') {
        if (!confirm('驴Eliminar esta reuni贸n?')) return;
        await eliminarReunion(r.id);
        await cargarReunionesDesdeApi();
      }
    });

    // INICIO
    (async function init() {
      idDispositivo = obtenerIdDispositivo();
      actualizarEstadoVista();
      btnExcel.disabled = true;
      await cargarReunionesDesdeApi();
    })();
  </script>
</body>
</html>
