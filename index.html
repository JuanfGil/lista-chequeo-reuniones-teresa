<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Lista de Chequeo - Reuniones Dra. Teresa Enr√≠quez Rosero</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      font-family: Calibri, Arial, sans-serif;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: #ffffff; /* Fondo blanco */
    }

    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Encabezado */
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .header-logo {
      width: 150px;
      height: 150px;
      border-radius: 10px;
      background: #f8bbd0; /* fucsia muy suave */
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      text-align: center;
      padding: 4px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(233, 30, 99, 0.25);
    }

    .header-logo img {
      width: 100%;
      height: 100%;
      object-fit: cover; /* mantiene proporci√≥n y rellena el cuadro */
    }

    .header-title {
      flex: 1;
      padding: 10px 16px;
      border-radius: 8px;
      background: linear-gradient(to right, #e91e63, #ff80ab); /* fucsia ‚Üí rosa */
      color: #fff;
      font-weight: bold;
      text-transform: uppercase;
      font-size: 14px;
      text-align: center;
      line-height: 1.3;
    }

    .header-format {
      padding: 10px 16px;
      border-radius: 8px;
      background-color: #ad1457; /* fucsia oscuro */
      color: #fff;
      font-weight: bold;
      text-align: center;
      min-width: 110px;
      text-transform: uppercase;
      font-size: 12px;
    }

    @media (max-width: 700px) {
      .header {
        flex-direction: column;
        align-items: center;
      }

      .header-logo {
        width: 200px;
        height: 200px;
        margin-bottom: 8px;
      }

      .header-title,
      .header-format {
        width: 100%;
      }

      .header-title {
        font-size: 13px;
      }
    }

    /* Layout principal */
    .content {
      display: grid;
      grid-template-columns: 1fr 1.1fr;
      gap: 16px;
    }

    @media (max-width: 900px) {
      .content {
        grid-template-columns: 1fr;
      }
    }

    /* Tarjetas */
    .card {
      border-radius: 8px;
      border: 1px solid #f8bbd0;
      padding: 14px;
      background-color: #ffffff;
      box-shadow: 0 2px 4px rgba(233, 30, 99, 0.08);
    }

    .card-title {
      margin-top: 0;
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 13px;
      text-transform: uppercase;
      padding: 8px 10px;
      border-radius: 6px;
      background-color: #fce4ec; /* fucsia claro */
      color: #880e4f;
    }

    /* Formulario: todo en columna para m√≥vil */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      font-size: 13px;
    }

    .form-group label {
      margin-bottom: 3px;
      font-weight: 600;
    }

    .form-group input,
    .form-group textarea {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 60px;
    }

    /* Botones */
    .btn-row {
      margin-top: 16px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 13px;
      cursor: pointer;
      font-weight: 600;
      min-width: 130px;
    }

    .btn-primary {
      background-color: #e91e63; /* fucsia */
      color: #fff;
    }

    .btn-secondary {
      background-color: #f06292; /* fucsia medio */
      color: #fff;
    }

    .btn-danger {
      background-color: #d32f2f;
      color: #fff;
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 12px;
      min-width: auto;
      border-radius: 16px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    @media (max-width: 700px) {
      .btn-row {
        flex-direction: column;
      }
      .btn {
        width: 100%;
        justify-content: center;
      }
    }

    /* Tabla */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    thead {
      background-color: #ad1457; /* fucsia oscuro */
      color: #fff;
    }

    th, td {
      border: 1px solid #f8bbd0;
      padding: 6px;
      text-align: left;
      vertical-align: top;
    }

    tbody tr:nth-child(even) {
      background-color: #fce4ec;
    }

    .actions-cell {
      white-space: nowrap;
      text-align: center;
    }

    .top-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      font-size: 12px;
      flex: 1;
      min-width: 180px;
    }

    .filter-group input {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 12px;
    }

    .admin-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 11px;
      justify-content: flex-end;
    }

    #estadoVista {
      font-style: italic;
      color: #880e4f;
    }

    @media (max-width: 700px) {
      .admin-controls {
        justify-content: flex-start;
      }
    }

    /* Modal administrador */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: #fff;
      border-radius: 10px;
      padding: 18px 16px;
      max-width: 320px;
      width: 90%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
    }

    .modal-title {
      margin: 0 0 10px;
      font-size: 14px;
      font-weight: bold;
      color: #880e4f;
    }

    .modal p {
      margin: 0 0 10px;
      font-size: 12px;
    }

    .modal input[type="password"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 13px;
      margin-bottom: 12px;
    }

    .modal-btns {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="header">
      <div class="header-logo">
        <!-- Foto Dra. Teresa -->
        <img src="teresaaa.jpg" alt="Dra. Teresa Enr√≠quez Rosero"
             onerror="this.style.display='none'; this.parentElement.innerHTML='Foto<br>Dra. Teresa';">
      </div>
      <div class="header-title">
        Lista de Chequeo - Agendamiento Reuniones<br>
        Dra. Teresa Enr√≠quez Rosero
      </div>
      <div class="header-format">
        Formato 1
      </div>
    </header>

    <div class="content">
      <!-- FORMULARIO -->
      <section class="card">
        <h2 class="card-title">Datos de la reuni√≥n</h2>

        <div class="form-grid">
          <div class="form-group">
            <label for="delegados">Delegados</label>
            <input type="text" id="delegados" />
          </div>

          <div class="form-group">
            <label for="fecha">Fecha</label>
            <input type="date" id="fecha" />
          </div>

          <div class="form-group">
            <label for="hora">Hora</label>
            <input type="time" id="hora" />
          </div>

          <div class="form-group">
            <label for="lugar">Lugar</label>
            <input type="text" id="lugar" />
          </div>

          <div class="form-group">
            <label for="municipio">Municipio</label>
            <input type="text" id="municipio" />
          </div>

          <div class="form-group">
            <label for="lider">L√≠der u organizaci√≥n que convoca</label>
            <input type="text" id="lider" />
          </div>

          <div class="form-group">
            <label for="celular">Celular</label>
            <input type="tel" id="celular" />
          </div>

          <div class="form-group">
            <label for="asistentes">N√∫mero de asistentes</label>
            <input type="number" id="asistentes" min="0" />
          </div>

          <div class="form-group">
            <label for="tipoPoblacion">Tipo de poblaci√≥n</label>
            <input type="text" id="tipoPoblacion" />
          </div>

          <div class="form-group">
            <label for="observaciones">Observaciones</label>
            <textarea id="observaciones"></textarea>
          </div>

          <div class="form-group">
            <label for="notas">Notas pendientes por parte de la Dra. Teresa Enr√≠quez / Delegado</label>
            <textarea id="notas"></textarea>
          </div>
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" id="btnGuardar">Guardar reuni√≥n</button>
          <button class="btn btn-secondary" id="btnLimpiar">Limpiar formulario</button>
        </div>
      </section>

      <!-- TABLA -->
      <section class="card">
        <h2 class="card-title" style="background-color:#e91e63; color:#fff;">
          Listado de reuniones agendadas
        </h2>

        <div class="top-controls">
          <div class="filter-group">
            <label for="filtroDelegado">Filtrar por delegado</label>
            <input type="text" id="filtroDelegado" placeholder="Escribe el nombre del delegado" />
          </div>

          <div class="admin-controls">
            <button class="btn btn-secondary btn-sm" id="btnAdmin">Activar modo administrador</button>
            <button class="btn btn-primary btn-sm" id="btnExcel" disabled>Descargar Excel</button>
            <span id="estadoVista"></span>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Delegados</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Lugar</th>
              <th>Municipio</th>
              <th>L√≠der u organizaci√≥n</th>
              <th>Celular</th>
              <th>N¬∞ asistentes</th>
              <th>Tipo de poblaci√≥n</th>
              <th>Observaciones</th>
              <th>Notas pendientes</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaReuniones">
            <!-- Filas generadas por JavaScript -->
          </tbody>
        </table>
      </section>
    </div>
  </div>

  <!-- MODAL ADMIN -->
  <div class="modal-backdrop" id="modalAdmin">
    <div class="modal">
      <h3 class="modal-title">Modo administrador</h3>
      <p>Ingresa la contrase√±a para ver todas las reuniones y habilitar edici√≥n/eliminaci√≥n.</p>
      <input type="password" id="inputAdminPwd" placeholder="Contrase√±a" />
      <div class="modal-btns">
        <button class="btn btn-secondary btn-sm" id="btnCancelarAdmin">Cancelar</button>
        <button class="btn btn-primary btn-sm" id="btnConfirmarAdmin">Aceptar</button>
      </div>
    </div>
  </div>

  <script>
    // ----- CONFIGURACI√ìN FRONTEND -----
    const DEVICE_KEY = 'idDispositivoTeresa';
    const ADMIN_PASSWORD = 'teresa2025';

    // üëá CAMBIA esto por la URL de tu servicio en Render
    // Ejemplo: 'https://lista-chequeo-api-teresa.onrender.com'
    const API_BASE_URL = 'https://lista-chequeo-reuniones-teresa.onrender.com';

    let reuniones = [];
    let indiceEdicion = null; // null = creando, n√∫mero = editando
    let modoAdmin = false;
    let idDispositivo = null;

    // ----- Referencias a elementos -----
    const inputDelegados = document.getElementById('delegados');
    const inputFecha = document.getElementById('fecha');
    const inputHora = document.getElementById('hora');
    const inputLugar = document.getElementById('lugar');
    const inputMunicipio = document.getElementById('municipio');
    const inputLider = document.getElementById('lider');
    const inputCelular = document.getElementById('celular');
    const inputAsistentes = document.getElementById('asistentes');
    const inputTipoPoblacion = document.getElementById('tipoPoblacion');
    const inputObservaciones = document.getElementById('observaciones');
    const inputNotas = document.getElementById('notas');

    const btnGuardar = document.getElementById('btnGuardar');
    const btnLimpiar = document.getElementById('btnLimpiar');
    const tbody = document.getElementById('tablaReuniones');

    const filtroDelegado = document.getElementById('filtroDelegado');
    const btnAdmin = document.getElementById('btnAdmin');
    const btnExcel = document.getElementById('btnExcel');
    const estadoVista = document.getElementById('estadoVista');

    const modalAdmin = document.getElementById('modalAdmin');
    const inputAdminPwd = document.getElementById('inputAdminPwd');
    const btnCancelarAdmin = document.getElementById('btnCancelarAdmin');
    const btnConfirmarAdmin = document.getElementById('btnConfirmarAdmin');

    // ----- Funciones generales -----
    function generarIdDispositivo() {
      return 'disp-' + Date.now() + '-' + Math.floor(Math.random() * 100000);
    }

    function obtenerIdDispositivo() {
      let id = localStorage.getItem(DEVICE_KEY);
      if (!id) {
        id = generarIdDispositivo();
        localStorage.setItem(DEVICE_KEY, id);
      }
      return id;
    }

    function obtenerDatosFormulario() {
      return {
        delegados: inputDelegados.value.trim(),
        fecha: inputFecha.value,
        hora: inputHora.value,
        lugar: inputLugar.value.trim(),
        municipio: inputMunicipio.value.trim(),
        lider: inputLider.value.trim(),
        celular: inputCelular.value.trim(),
        asistentes: inputAsistentes.value ? parseInt(inputAsistentes.value, 10) : null,
        tipoPoblacion: inputTipoPoblacion.value.trim(),
        observaciones: inputObservaciones.value.trim(),
        notas: inputNotas.value.trim(),
        dispositivoId: idDispositivo
      };
    }

    function validarDatos(datos) {
      if (!datos.delegados) return 'El campo "Delegados" es obligatorio.';
      if (!datos.fecha) return 'El campo "Fecha" es obligatorio.';
      if (!datos.hora) return 'El campo "Hora" es obligatorio.';
      if (!datos.lugar) return 'El campo "Lugar" es obligatorio.';
      if (!datos.municipio) return 'El campo "Municipio" es obligatorio.';
      if (!datos.lider) return 'El campo "L√≠der u organizaci√≥n que convoca" es obligatorio.';
      return null;
    }

    function limpiarFormulario() {
      inputDelegados.value = '';
      inputFecha.value = '';
      inputHora.value = '';
      inputLugar.value = '';
      inputMunicipio.value = '';
      inputLider.value = '';
      inputCelular.value = '';
      inputAsistentes.value = '';
      inputTipoPoblacion.value = '';
      inputObservaciones.value = '';
      inputNotas.value = '';
      indiceEdicion = null;
      btnGuardar.textContent = 'Guardar reuni√≥n';
    }

    function actualizarEstadoVista() {
      if (modoAdmin) {
        estadoVista.textContent = 'Mostrando todas las reuniones (modo administrador).';
      } else {
        estadoVista.textContent = 'Mostrando solo las reuniones creadas en este dispositivo.';
      }
    }

    function obtenerRegistrosFiltrados() {
      const textoFiltro = filtroDelegado.value.toLowerCase().trim();
      let base = [...reuniones];

      if (textoFiltro) {
        base = base.filter(r =>
          (r.delegados || '').toLowerCase().includes(textoFiltro)
        );
      }

      return base;
    }

    function pintarTabla() {
      const registros = obtenerRegistrosFiltrados();
      tbody.innerHTML = '';

      registros.forEach((r, index) => {
        const tr = document.createElement('tr');

        let accionesHTML = '';
        if (modoAdmin) {
          accionesHTML = `
            <button class="btn btn-secondary btn-sm" data-accion="editar" data-index="${index}">Editar</button>
            <button class="btn btn-danger btn-sm" data-accion="eliminar" data-index="${index}">Eliminar</button>
          `;
        } else {
          accionesHTML = '<span style="font-size:11px; color:#777;">Solo administrador</span>';
        }

        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${r.delegados || ''}</td>
          <td>${r.fecha || ''}</td>
          <td>${r.hora || ''}</td>
          <td>${r.lugar || ''}</td>
          <td>${r.municipio || ''}</td>
          <td>${r.lider || ''}</td>
          <td>${r.celular || ''}</td>
          <td>${r.asistentes ?? ''}</td>
          <td>${r.tipo_poblacion || r.tipoPoblacion || ''}</td>
          <td>${r.observaciones || ''}</td>
          <td>${r.notas || ''}</td>
          <td class="actions-cell">
            ${accionesHTML}
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    function escapeCSV(value) {
      if (value === null || value === undefined) return '';
      const str = String(value).replace(/"/g, '""');
      if (/[;"\n\r]/.test(str)) {
        return `"${str}"`;
      }
      return str;
    }

    function descargarExcel() {
      const registros = obtenerRegistrosFiltrados();
      if (!registros.length) {
        alert('No hay registros para exportar.');
        return;
      }

      const encabezados = [
        'Delegados',
        'Fecha',
        'Hora',
        'Lugar',
        'Municipio',
        'L√≠der u organizaci√≥n',
        'Celular',
        'N√∫mero de asistentes',
        'Tipo de poblaci√≥n',
        'Observaciones',
        'Notas pendientes'
      ];

      const filas = registros.map(r => [
        r.delegados || '',
        r.fecha || '',
        r.hora || '',
        r.lugar || '',
        r.municipio || '',
        r.lider || '',
        r.celular || '',
        r.asistentes ?? '',
        r.tipo_poblacion || r.tipoPoblacion || '',
        r.observaciones || '',
        r.notas || ''
      ]);

      const lineas = [];
      lineas.push(encabezados.map(escapeCSV).join(';'));
      filas.forEach(fila => {
        lineas.push(fila.map(escapeCSV).join(';'));
      });

      const csvContent = lineas.join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'reuniones_dra_teresa.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ----- Llamadas a la API -----
    async function cargarReunionesDesdeApi() {
      try {
        let url = `${API_BASE_URL}/api/reuniones`;
        if (modoAdmin) {
          url += `?modo=admin&password=${encodeURIComponent(ADMIN_PASSWORD)}`;
        } else {
          url += `?dispositivoId=${encodeURIComponent(idDispositivo)}`;
        }

        const res = await fetch(url);
        if (!res.ok) {
          throw new Error('Error al consultar reuniones');
        }

        reuniones = await res.json();
        pintarTabla();
      } catch (err) {
        console.error(err);
        alert('No se pudieron cargar las reuniones desde el servidor.');
      }
    }

    async function crearReunion(datos) {
      const res = await fetch(`${API_BASE_URL}/api/reuniones`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
      });
      if (!res.ok) throw new Error('Error al crear reuni√≥n');
      return res.json();
    }

    async function actualizarReunion(id, datos) {
      const res = await fetch(`${API_BASE_URL}/api/reuniones/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(datos)
      });
      if (!res.ok) throw new Error('Error al actualizar reuni√≥n');
      return res.json();
    }

    async function eliminarReunion(id) {
      const res = await fetch(`${API_BASE_URL}/api/reuniones/${id}`, {
        method: 'DELETE'
      });
      if (!res.ok) throw new Error('Error al eliminar reuni√≥n');
      return res.json();
    }

    // ----- Modal admin -----
    function abrirModalAdmin() {
      inputAdminPwd.value = '';
      modalAdmin.style.display = 'flex';
      setTimeout(() => inputAdminPwd.focus(), 50);
    }

    function cerrarModalAdmin() {
      modalAdmin.style.display = 'none';
    }

    async function intentarEntrarAdmin() {
      const pwd = inputAdminPwd.value;
      if (pwd === ADMIN_PASSWORD) {
        modoAdmin = true;
        cerrarModalAdmin();
        actualizarEstadoVista();
        await cargarReunionesDesdeApi();
        btnAdmin.textContent = 'Salir de modo administrador';
        btnExcel.disabled = false;
      } else {
        alert('Contrase√±a incorrecta.');
        inputAdminPwd.focus();
      }
    }

    // ----- Eventos -----
    btnGuardar.addEventListener('click', async () => {
      const datos = obtenerDatosFormulario();
      const error = validarDatos(datos);

      if (error) {
        alert(error);
        return;
      }

      try {
        if (indiceEdicion === null) {
          await crearReunion(datos);
        } else {
          const registro = reuniones[indiceEdicion];
          await actualizarReunion(registro.id, datos);
        }

        await cargarReunionesDesdeApi();
        limpiarFormulario();
      } catch (err) {
        console.error(err);
        alert('Ocurri√≥ un error guardando la reuni√≥n.');
      }
    });

    btnLimpiar.addEventListener('click', () => {
      limpiarFormulario();
    });

    filtroDelegado.addEventListener('input', () => {
      pintarTabla();
    });

    btnAdmin.addEventListener('click', async () => {
      if (modoAdmin) {
        modoAdmin = false;
        btnAdmin.textContent = 'Activar modo administrador';
        btnExcel.disabled = true;
        actualizarEstadoVista();
        await cargarReunionesDesdeApi();
      } else {
        abrirModalAdmin();
      }
    });

    btnExcel.addEventListener('click', () => {
      if (!modoAdmin) {
        alert('Solo el administrador puede descargar el Excel.');
        return;
      }
      descargarExcel();
    });

    tbody.addEventListener('click', async (event) => {
      const btn = event.target;
      const accion = btn.getAttribute('data-accion');
      const index = btn.getAttribute('data-index');

      if (!accion || index === null) return;
      const idx = parseInt(index, 10);

      if (!modoAdmin) {
        alert('Solo el administrador puede editar o eliminar registros.');
        return;
      }

      if (accion === 'editar') {
        const r = reuniones[idx];
        inputDelegados.value = r.delegados || '';
        inputFecha.value = r.fecha || '';
        inputHora.value = r.hora || '';
        inputLugar.value = r.lugar || '';
        inputMunicipio.value = r.municipio || '';
        inputLider.value = r.lider || '';
        inputCelular.value = r.celular || '';
        inputAsistentes.value = r.asistentes ?? '';
        inputTipoPoblacion.value = r.tipo_poblacion || r.tipoPoblacion || '';
        inputObservaciones.value = r.observaciones || '';
        inputNotas.value = r.notas || '';

        indiceEdicion = idx;
        btnGuardar.textContent = 'Actualizar reuni√≥n';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      if (accion === 'eliminar') {
        const confirmar = confirm('¬øDeseas eliminar esta reuni√≥n?');
        if (!confirmar) return;

        try {
          const r = reuniones[idx];
          await eliminarReunion(r.id);
          await cargarReunionesDesdeApi();
        } catch (err) {
          console.error(err);
          alert('No se pudo eliminar la reuni√≥n.');
        }
      }
    });

    // Modal eventos
    btnCancelarAdmin.addEventListener('click', () => {
      cerrarModalAdmin();
    });

    btnConfirmarAdmin.addEventListener('click', () => {
      intentarEntrarAdmin();
    });

    inputAdminPwd.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        intentarEntrarAdmin();
      }
    });

    modalAdmin.addEventListener('click', (e) => {
      if (e.target === modalAdmin) {
        cerrarModalAdmin();
      }
    });

    // ----- Inicio -----
    (async function init() {
      idDispositivo = obtenerIdDispositivo();
      actualizarEstadoVista();
      await cargarReunionesDesdeApi();
      btnExcel.disabled = true;
    })();
  </script>
</body>
</html>
